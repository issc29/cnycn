// Generated by CoffeeScript 1.3.3
(function() {

  $(document).ready(function() {
    var box, filterFor, questionData, saveAccumulatedData;
    $('a').each(function() {
      var match;
      if ($(this).attr('href') && $(this).attr('href') !== '#') {
        match = $(this).attr('href').match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);
        if ((typeof match[1] === "string" && match[1].length > 0 && match[1].toLowerCase() !== location.protocol) || (typeof match[2] === "string" && match[2].length > 0 && match[2].replace(new RegExp(":(" + {
          "http:": 80,
          "https:": 443
        }[location.protocol] + ")?$"), "") !== location.host)) {
          return $(this).attr('target', '_blank');
        }
      }
    });
    $('#navigation .subscribe').validate({
      rules: {
        'EMAIL': {
          required: true,
          email: true
        }
      },
      messages: {
        'EMAIL': {
          required: 'Please enter your email address.',
          email: 'Please enter a valid email address.'
        }
      }
    });
    $('#cyoa-email').validate({
      rules: {
        'maile': {
          required: true,
          email: true
        }
      },
      messages: {
        'maile': {
          required: 'Please enter your email address.',
          email: 'Please enter a valid email address.'
        }
      },
      submitHandler: function(form) {
        var email;
        email = $('#cyoa-email').find('.input-text').val();
        $.ajax({
          type: 'POST',
          url: '/wp-content/themes/floodhelpny-wp/ajax/email_cyoa_results.php',
          data: {
            maile: $('#cyoa-email').find('.input-text').val(),
            results: questionData,
            location: box || null
          },
          success: function(data) {
            return $('#cyoa-email').replaceWith("<div id=\"cyoa-email-sent\"><strong>Sent!</strong><br/>Your results have been sent to " + email + ".</div>");
          }
        });
        return false;
      }
    });
    $('#navigation').on('click', 'li:first-child a', function(event) {
      return $(event.currentTarget).toggleClass('open').closest('ul').toggleClass('open');
    });
    $('#content .column-right p a[href="#"]').unwrap();
    $('#content .column-right a[href="#"]').addClass('expand').removeAttr('href').find('br').remove().end().append('&nbsp;<span class="plus">[+]</span><span class="plus" style="display:none;">[-]</span>').each(function() {
      var next, set;
      set = $();
      next = this.nextSibling;
      while (next) {
        if (!$(next).hasClass('expand') && !($(next).is('p') && $(next).find('a').length === 1)) {
          set.push(next);
          next = next.nextSibling;
        } else {
          break;
        }
      }
      return set.wrapAll('<div class="expand-section" />');
    });
    $('.expand').each(function() {
      if ($(this).text().indexOf('Zone') >= 0 || $(this).text().indexOf('zone') >= 0) {
        if ($(this).text().indexOf('VE') >= 0) {
          $(this).next('.expand-section').addClass('zone-V');
        }
        if ($(this).text().indexOf('AE') >= 0) {
          $(this).next('.expand-section').addClass('zone-A');
        }
        if ($(this).text().indexOf('A') >= 0) {
          $(this).next('.expand-section').addClass('zone-A');
        }
        if ($(this).text().indexOf('AO') >= 0) {
          $(this).next('.expand-section').addClass('zone-A');
        }
        if ($(this).text().indexOf('X') >= 0) {
          $(this).next('.expand-section').addClass('zone-X');
        }
        if ($(this).text().indexOf('current') >= 0) {
          $(this).next('.expand-section').addClass('zone-current');
        }
        if ($(this).text().indexOf('not in a flood zone') >= 0) {
          $(this).next('.expand-section').addClass('zone-N').addClass('zone-current').addClass('zone-updated');
        }
        if ($(this).text().indexOf('updated') >= 0) {
          $(this).next('.expand-section').addClass('zone-updated');
        }
        if ($(this).text().indexOf('not') >= 0 && $(this).text().indexOf('changing') >= 0) {
          return $(this).next('.expand-section').addClass('zone-no-change');
        }
      }
    });
    $('#content').on('click', '.expand', function(event) {
      return $(event.currentTarget).toggleClass('open').find('.plus').toggle().end().next('.expand-section').slideToggle('fast');
    });
    $('#content').find('p,div,li').each(function() {
      if ($(this).text().indexOf('Caution:') === 0 || $(this).text().indexOf('CAUTION:') === 0) {
        return $(this).addClass('box-caution').append('<a class="caution-close">OK</a>');
      }
    });
    $('#content').on('click', '.caution-close', function(event) {
      return $(event.currentTarget).closest('.box-caution').slideUp('fast');
    });
    if ($.cookie('address')) {
      box = "<div id=\"current-zone-box\" class=\"box-current\">      <p class=\"heading\"><strong>Your Results</strong></p>      <p><span class=\"marker\"></span>" + ($.cookie('address')) + "</p>      <p class=\"half\"><strong>Flood Zone Today</strong> " + ($.cookie('cFLD_ZONE')) + "</p>      <p class=\"half\"><strong>Flood Zone 2016</strong> " + ($.cookie('pFLD_ZONE')) + "</p>      <p class=\"half\"><strong>BFE Today</strong> " + ($.cookie('cSTATIC_BFE')) + "</p>      <p class=\"half\"><strong>BFE 2016</strong> " + ($.cookie('pSTATIC_BFE')) + "</p>      <a class=\"close\"></a>    </div>";
      $('#content .column-right').prepend(box);
      filterFor = ".zone-current.zone-" + ($.cookie('cFLD_ZONE').charAt(0));
      if ($.cookie('cFLD_ZONE') === $.cookie('pFLD_ZONE')) {
        filterFor += ',.zone-no-change';
      } else {
        filterFor += ",.zone-updated.zone-" + ($.cookie('pFLD_ZONE').charAt(0));
      }
      $('.expand-section').filter(filterFor).slideDown('fast').prev('.expand').addClass('open').find('.plus').toggle();
    }
    console.log(filterFor);
    $('#current-zone-box').on('click', '.close', function() {
      return $('#current-zone-box').slideUp('fast');
    });
    questionData = [];
    saveAccumulatedData = function() {
      return questionData = _.map($('#content .q.open'), function(item) {
        return {
          question: $(item).children('.q-question').html(),
          answer: $(item).children('.q-buttons').find('.selected').text()
        };
      });
    };
    $('#questions1').on('click', '.q-button', function(event) {
      var button;
      button = $(event.currentTarget);
      button.parent().siblings('.q').hide().removeClass('open');
      button.addClass('selected').siblings('.q-button').removeClass('selected');
      saveAccumulatedData();
      if (button.data('q-to')) {
        $('#questions2').find('.q').hide();
        return button.parent().siblings(".q-" + (button.data('q-to'))).addClass('open').slideDown('fast');
      } else {
        return $('#questions2 .q:first-child').addClass('open').slideDown('fast');
      }
    });
    return $('#questions2').on('click', '.q-button', function(event) {
      var button, selectedSection;
      button = $(event.currentTarget);
      button.parent().siblings('.q').removeClass('open').hide();
      button.addClass('selected').siblings('.q-button').removeClass('selected');
      saveAccumulatedData();
      $('#questions2').find('.box-current').removeClass('box-current');
      selectedSection = button.parent().siblings(".q-" + (button.data('q-to')));
      selectedSection.addClass('open').slideDown('fast');
      if (!selectedSection.find('.q-buttons').length) {
        selectedSection.addClass('box-current');
        $('#cyoa-email').show();
        return saveAccumulatedData();
      }
    });
  });

}).call(this);
